# ZT DNS Companion

## About

This tool allows you to query your [ZeroTier](https://zerotier.com) networks and create per-interface DNS settings for name resolution. Whether you use a managed or self-hosted controller, you can configure at the controller level [custom DNS server and search domain](https://docs.zerotier.com/dns-management) downstream to the client. Windows, macOS, Android, and iOS all have the capability of auto-configuring their systems to utilize this setting. If you are running a Linux host, you need to perform extra configuration due to the many types of network tools available. This utility aims to automate that work.

## Disclaimer

ZT DNS Companion is an independent project and is not affiliated with, endorsed by, or sponsored by ZeroTier, Inc. Any references to ZeroTier are solely for the purpose of describing the functionality of this tool, which is designed to enhance the usage of the ZeroTier product. This tool is provided as-is and is not an official ZeroTier product.

## Maintainer

nfrastack <code@nfrastack.com>

## Table of Contents

- [About](#about)
- [Disclaimer](#disclaimer)
- [Maintainer](#maintainer)
- [Table of Contents](#table-of-contents)
- [Prerequisites and Assumptions](#prerequisites-and-assumptions)
- [Configuration](#configuration)
  - [Quick Start](#quick-start)
  - [Command Line Arguments](#command-line-arguments)
  - [Filtering Networks and Interfaces](#filtering-networks-and-interfaces)
    - [Examples](#examples)
  - [Configuration File](#configuration-file)
    - [Example Configuration File](#example-configuration-file)
    - [Using Profiles](#using-profiles)
- [Running in Background](#running-in-background)
- [Installing](#installing)
  - [From Source](#from-source)
  - [Precompiled Binaries](#precompiled-binaries)
    - [Supported Architectures](#supported-architectures)
    - [How to Download](#how-to-download)
    - [How to Use](#how-to-use)
  - [Distributions](#distributions)
    - [NixOS](#nixos)
- [Support](#support)
  - [Usage](#usage)
  - [Bugfixes](#bugfixes)
  - [Feature Requests](#feature-requests)
  - [Updates](#updates)
- [References](#references)
- [License](#license)

## Prerequisites and Assumptions

- Assumes you have the ZeroTier-One client installed and are connected to one or more networks.
- An available DNS server to serve records.
- Utilizing either:
  - `systemd-networkd`, a system service that manages network configurations, primarily for servers and headless Linux systems.
  - `systemd-resolved`, a system service that provides network name resolution for local applications on Linux systems. It works alongside [NetworkManager](https://wiki.archlinux.org/title/NetworkManager#systemd-resolved), [ConnMan](https://wiki.archlinux.org/title/ConnMan#Using_systemd-resolved), and [`iwd`](https://wiki.archlinux.org/title/Iwd#Select_DNS_manager), making this suitable for those using desktop Linux.

## Configuration

### Quick Start

Run `zt-dns-companion` as `root` with appropriate command-line arguments. If you are connected to ZeroTier networks that have DNS assignments, depending on which `-mode` you are running, it will:

- `networkd`: Populate files in `/etc/systemd/network/99-<network-name>`. It will then restart `systemd-networkd` for you if things have changed.
- `resolved`: Populate search domains and DNS server entries with `resolvectl` if entries don't already exist.

### Command Line Arguments

To change the way the tool operates, you can pass various arguments via the command line.

- `-config-file`: Specify a custom configuration file. By default it looks for existence at `/etc/zt-dns-companion.conf` If the file does not exist and this argument, it will be autogenerated with default values and any other command-line arguments passed to the binary.
- `-profile`: Specify the profile to use from the configuration file. Defaults to `default`.
- `-version`: Print the version and exit.
- `-help`: Show help message and exit.
- `-log-level`: Set the logging level (`info` or `debug`).
- `-log-timestamps`: Enable timestamps in logs. Default: `false`.
- `-dry-run`: Simulate changes without applying them.
- `-mode`: Set the mode of operation (`networkd` or `resolved`) (default: autodetected).
- `-host`: ZeroTier client host address (default: `http://localhost`).
- `-port`: ZeroTier client port number (default: `9993`).
- `-token-file`: Path to the ZeroTier authentication token file (default: `/var/lib/zerotier-one/authtoken.secret`).
- `-token`: ZeroTier authentication token (overrides `-token-file` if provided).
- `-add-reverse-domains`: Add reverse DNS search domains (e.g., `in-addr.arpa`, `ip6.arpa`) based on assigned IPs (default: false).
- `-auto-restart`: (networkd) Automatically restart `systemd-networkd` when changes are detected (default: true).
- `-dns-over-tls`: Enable DNS-over-TLS for supported configurations (default: false).
- `-multicast-dns`: Enable multicast DNS (mDNS) for ZeroTier interfaces (default: false).
- `-reconcile`: (networkd) Remove unused network files when networks are no longer active (default: true).

### Filtering Networks and Interfaces

ZT DNS Companion provides a unified filtering system to control which networks and interfaces are processed:

- `-filter-type`: Type of filter to apply. Options are:
  - `interface` - Filter by interface names
  - `network` - Filter by network names
  - `network_id` - Filter by network IDs
  - `none` - No filtering (process all)

- `-filter-include`: Comma-separated list of items to include based on filter-type. Empty or special values (`any`, `all`, `ignore`) mean "include all".

- `-filter-exclude`: Comma-separated list of items to exclude based on filter-type. Empty or special values (`none`, `ignore`) mean "exclude none".

The filter system ensures that only one type of filtering is active at a time to prevent conflicts.

#### Examples

- Filter by interface names, including only specific interfaces:

  ```bash
  ./zt-dns-companion -filter-type interface -filter-include=zt12345678,zt87654321
  ```

- Filter by network names, excluding specific networks:

  ```bash
  ./zt-dns-companion -filter-type network -filter-exclude=unwanted_network1,unwanted_network2
  ```

- Filter by network IDs:

  ```bash
  ./zt-dns-companion -filter-type network_id -filter-include=a1b2c3d4,d4c3b2a1
  ```

- Process all networks without filtering:

  ```bash
  ./zt-dns-companion -filter-type none
  ```

- Using special values to explicitly include all or exclude none:

  ```bash
  ./zt-dns-companion -filter-type interface -filter-include=any -filter-exclude=none
  ```

### Configuration File

ZT DNS Companion uses a TOML-based configuration file for managing options. By default, it looks for a configuration file at `/etc/zt-dns-companion.conf`. You can also specify a custom configuration file using the `-config-file` command-line argument.

#### Example Configuration File

An example configuration file is provided in the repository as `contrib/config/zt-dns-companion.conf`. Below is an example:

```toml
# Default profile
[default]
mode = "auto"
log_level = "info"
host = "http://localhost"
port = 9994
dns_over_tls = false
auto_restart = true
add_reverse_domains = false
filter_type = "none"
filter_include = []
filter_exclude = []

# Profiles for specific configurations
[profiles.example1]
filter_type = "interface"
filter_include = ["zt12345678", "zt87654321"]
auto_restart = false

[profiles.example2]
filter_type = "network"
filter_include = ["ztnetwork1", "ztnetwork2"]
mode = "resolved"
dns_over_tls = true

[profiles.example3]
mode = "networkd"
auto_restart = false
filter_type = "network"
filter_exclude = ["network2"]

# Example showing special filter values
[profiles.allNetworks]
filter_type = "network"
filter_include = ["any"]  # Special value to include all networks
filter_exclude = ["none"] # Special value to exclude nothing
```

#### Using Profiles

- The `default` profile contains global settings.
- Additional profiles can be defined under `[profiles.<name>]` for specific configuration scenarios.
- You can switch between profiles using the `-profile` command-line argument.

## Running in Background

This should be run as a systemd service and timer as it only bases its information on the present moment. It will not monitor if you change DNS server settings on your controller, and if using `resolved` mode, it will not survive a reboot. See [contrib/systemd](contrib/systemd) for examples of units and timers that can be implemented into your distribution to monitor all or individual interfaces.

## Installing

### From Source

Clone this repository and compile with [GoLang 1.21 or later](https://golang.org):

```bash
go build ./cmd/zt-dns-companion/
```

### Precompiled Binaries

Precompiled binaries are available for download from the [GitHub Releases](https://github.com/nfrastack/zt-dns-companion/releases) page. These binaries are created only for tagged releases.

#### Supported Architectures

- `x86_64` (64-bit Linux)
- `aarch64` (ARM 64-bit Linux)

#### How to Download

1. Visit the [Releases](https://github.com/nfrastack/zt-dns-companion/releases) page.
2. Locate the release you want to download.
3. Download the binary for your architecture:
   - `zt-dns-companion_x86_64` for 64-bit Linux.
   - `zt-dns-companion_aarch64` for ARM 64-bit Linux.

#### How to Use

1. Make the binary executable:

   ```bash
   chmod +x zt-dns-companion-<architecture>
   ```

2. Move it to a directory in your `PATH` (e.g., `/usr/local/bin`):

   ```bash
   sudo mv zt-dns-companion_<architecture> /usr/local/bin/zt-dns-companion
   ```

3. Run the binary:

   ```bash
   zt-dns-companion --help
   ```

### Distributions

#### NixOS

See [contrib/nixos](contrib/nixos) for installation instructions and a module that can be used to configure.

## Support

### Usage

- The [Discussions board](../../discussions) is a great place for working with the community.

### Bugfixes

- Please submit a [Bug Report](issues/new) if something isn't working as expected. I'll do my best to issue a fix in short order.

### Feature Requests

- Feel free to submit a feature request; however, there is no guarantee that it will be added or at what timeline.

### Updates

- Best effort to track upstream dependency changes, with more priority if I am actively using the tool.

## References

- [zerotier-systemd-manager](https://github.com/zerotier/zerotier-systemd-manager) - Original forked project by Erik Hollensbe <github@hollensbe.org>.
- [zerotier-resolved](https://github.com/twisteroidambassador/zerotier-resolved) - Adds `resolvectl` settings via a Python script.
- [zeronsd](https://github.com/zerotier/zeronsd) - DNS server that maps member IDs and names to IP addresses on a ZeroTier network.

## License

BSD 3-Clause. See [LICENSE](LICENSE) for more details.
